# Typst & Syntax Highlighting
One of the problems with Tree-sitter is that, because it's so C-based, Rust developers are generally uncomfortable relying on it. That's fair enough, but also _immensely_ annoying when it turns out that Typst doesn't support Tree-sitter for syntax highlighting in code blocks.

## Solution 1: A Bad Hack
Here's the basic idea:

1. Typst will happily load data from arbitrary files, and in particular it will load SVG files and render them accordingly.
2. Tree-sitter can emit highlighted code in HTML documents with the `tree-sitter highlight --html <FILENAME>` command.
3. [WebVector](https://cssbox.sourceforge.net/webvector/) can render HTML documents into SVG files.

So the "obvious" answer? Stick code snippets in a subfolder, render them into SVGs with Tree-sitter and WebVector (using `just` to orchestrate), and then point Typst at the resulting artifacts.

I can think of about 1000 potential problems with this system, but it does require the least work (for an oblique definition of least).

## Solution 2: A Custom Typst Plugin
It turns out that Typst has support for [custom WASM plugins](https://typst.app/docs/reference/foundations/plugin/) that can read multiple byte buffers as input and return a single byte buffer as output. Further, the Typst project provides [a nice Rust wrapper](https://github.com/astrale-sharp/wasm-minimal-protocol) for creating this kind of plugin.

Incidentally, it _also_ turns out that Tree-sitter can compile to a WASM target (using Emscripten); this is how the `tree-sitter playground` works, for example.

So to solve the syntax highlighting problem, you could:
1. Compile the Jabber parser to WASM.
2. Write a Rust plugin that loads the parser, as well as the [`tree-sitter-highlight` crate](https://crates.io/crates/tree-sitter-highlight), and returns the input code with corresponding inline ANSI-style color codes.
3. Wrap the Rust plugin with a Typst plugin that converts the ANSI-style byte stream back into Typst content, but now with attached color data.

This is obviously much more work than the first option, but would be "the best" in the sense that it would be the most correct.

Briefly, also note that [you can associate language tags with functions](https://typst.app/docs/reference/text/raw/).

## Solution 3: A Sublime Syntax File
Yeah, so it turns out Typst _does_ have a way to add custom syntax highlighting; it's just that that system is opaque and obscure.

A [`.sublime-syntax` file](https://www.sublimetext.com/docs/syntax.html) defines syntax highlighting information for use primarily by the Sublime Text editor. It has an odd notion of pushing and popping "scopes" to and from a stack. Also (and this is absolutely the worst bit), it's literally just YAML.

But as much as I hate it, this _is_ the blessed path; dare I stray from the light, even if it means suffering a YAML DSL for a minor text editor?
